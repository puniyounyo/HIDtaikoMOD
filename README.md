# HIDtaikoMOD ver.1.2.9c 説明概要書 

## 概要

このArduinoスケッチは、OLEDディスプレイを搭載した自作の太鼓コントローラーとして機能します。
Pro Microをベースとしており、以下の kasasiki3 氏の HIDtaiko プロジェクトの主要な機能を統合しています。

* **PC/SW切り替え方式 (Ver 1.2)**
* **遅延処理 (Ver 1.3)**
* **OLED表示と接続器単体での設定変更 (Ver 2.0)**

それぞれのモードで異なる入力方式で操作でき、設定モードではOLED画面を見ながらアナログセンサーの感度や各種遅延などのパラメータを調整し、EEPROMに保存できます。

**オリジナルのアイデア:** [kasasiki3](https://github.com/kasasiki3) さん

*更新履歴
- オリジナル版 1.2
- MOD版 1.2.1　ボツ
- MOD版 1.2.2　キーボードを離すまでの遅延処理追加（オリジナルver1.3相当)
- MOD版 1.2.3　EEPROMによる設定変更導入　スイッチモードNG
- MOD版 1.2.4　一旦完成
- MOD版 1.2.5　WS2812B LEDによる動作モード表示
- MOD版 1.2.6　大ドン、大カッの同時検出、出力対応　（テスト中） 
- MOD版 1.2.9c　なんやかんやで最終版（予定）
-  
### 主な特徴
* **PC/SW両対応**: 接続時の自動判別により、PC（キーボード）とNintendo Switchの両方で使用可能。
* **遅延の最小化**: `delay()`を徹底的に排除したロジックにより、入力の「滑り」を抑制。
* **オンボード設定**: PCモード中なら、OLEDを見ながらいつでも感度調整が可能。
* **HOMEボタン実装**: システムボタンの同時押しによるHOMEボタン機能を搭載。

---

## 2. 動作モードと切り替え方法

### 起動時モード判定
USB接続した瞬間の **デジタル15番ピン** の状態で動作モードが決定します。
* **15番ピンがLOW（ボタン押下中）**: **PCモード**（キーボード入力）
* **15番ピンがHIGH（ボタン未押下）**: **SWモード**（Nintendo Switch入力）

### 設定モード (PCモード専用)
PCモード動作中に **デジタル14番ピン** のボタンを押すと「SET MODE」に入ります。OLED画面で現在の設定項目と数値を確認しながら調整が可能です。

---

## 3. ピン配置表 (v1.2.9c 準拠)



| ピン番号 | シルク印字 | SWモード用途 | PCモード用途 | 設定モード用途 |
| :--- | :--- | :--- | :--- | :--- |
| **18 (A0)** | A0 | 右ドン (ZR) | 'k' キー | - |
| **19 (A1)** | A1 | 右カッ (Rスティック押) | 'j' キー | - |
| **20 (A2)** | A2 | 左縁 (Lスティック押) | 'f' キー | - |
| **21 (A3)** | A3 | 左面 (ZL) | 'd' キー | - |
| **5** | 5 | 十字キー (上) | 上矢印キー | **数値 ＋** |
| **4** | 4 | 十字キー (下) | 下矢印キー | **数値 －** |
| **10** | 10 | 十字キー (左) | - | - |
| **16** | 16 | 十字キー (右) | - | - |
| **7** | 7 | Aボタン | ENTERキー | **決定 (OK)** |
| **8** | 8 | Bボタン | ESCキー | - |
| **6** | 6 | Xボタン | F1キー | - |
| **9** | 9 | Yボタン | INSERTキー | - |
| **0** | 0 | Lボタン | - | - |
| **1** | 1 | Rボタン | - | - |
| **14** | 14 | MINUSボタン | **設定モード移行** | - |
| **15** | 15 | PLUSボタン | - | - |

> **システム操作 (SWモード):** 14番ピン(MINUS)と15番ピン(PLUS)を**同時押し**することで「HOMEボタン」が機能します。50msの猶予判定により、単押しとの誤作動を防止しています。

---

## 4. OLED接続 (I2C方式)

| Pro Microピン | シルク印字 | OLED側接続先 |
| :--- | :--- | :--- |
| **2** | 2 | SDA |
| **3** | 3 | SCL |
| **VCC** | VCC | VCC (3.3V/5V) |
| **GND** | GND | GND |

---

## 5. 設定項目の一覧 (全9項目)

PA〜PEは、PC/SW両モードにおけるアナログ入力の判定アルゴリズムで使用される共通の設定値です。

| 項目名 | 内容説明 | 判定ロジックへの影響 |
| :--- | :--- | :--- |
| **SE0-3** | 各面のアナログ閾値 | 叩いたと判定するセンサーの変化量。 |
| **PA** | 同一ピン再入力防止 | 同じ面を連続で叩いた際の最小間隔時間。 |
| **PB** | 異ピン同時入力防止 | 異なる面を叩いた際の判定インターバル。 |
| **PC** | 全体入力安定化 | 入力全体の「滑り」を抑制する待機時間。 |
| **PD** | 同時押し判定許容 | ドンとカッが混ざらないための同時押し判定範囲。 |
| **PE** | 信号保持時間 | 出力信号（キー/ボタン）を維持する時間の長さ。 |

---

## 6. 使用方法と注意点

1.  **初期設定**: 初回起動時はEEPROM内の数値が不定です。必ず設定モード（PCモードで起動→14ピン押下）に入り、調整・保存してください。
2.  **保存**: 最後の項目「PE」で決定ボタンを押すと、すべての設定が保存されます。
3.  **配線**: 以前のバージョンからピンアサインが大幅に変更されています。表を確認の上、配線を修正してください。
4.  **SWモードの使用**: Nintendo Switch本体の設定で「Proコントローラーの有線通信」をONにする必要があります。
