# HIDtaikoMOD
HIDtaiko ver.1.2.4 スケッチ説明書
概要
このArduinoスケッチは、自作の太鼓型入力デバイス「HIDtaiko」を制御するためのものです。PCモードとNintendo Switchモードを切り替えることができ、アナログ入力やデジタル入力に基づいて、それぞれに対応したキーボード入力やSwitchコントローラーのボタン入力をエミュレートします。また、OLEDディスプレイを搭載しており、動作モードや設定値を表示することができます。設定モードでは、アナログ入力の感度などのパラメータを調整し、EEPROMに保存することが可能です。

機能
PCモード:

アナログ入力（A0, A1, A2, A3ピン）の変化量と時間間隔に基づいて、設定されたキーボードキー（左、中央左、中央右、右）を押下・離します。
デジタル入力（4, 5, 6, 7, 8, 9ピン）の状態に基づいて、特定のキーボードキー（↑, Enter, F1, Insert, Esc, ↓）を送信します。
設定モードへの切り替えが可能です（14番ピンのボタン）。
Nintendo Switchモード:

アナログ入力（A0, A1, A2, A3ピン）の変化量と時間間隔に基づいて、設定されたSwitchコントローラーのボタン（ZR, Rスティッククリック, Lスティッククリック, ZL）を押下・離します。
デジタル入力（4, 5, 6, 7, 8, 9, 10ピン）の状態に基づいて、特定のSwitchコントローラーのボタン（R, +, A, B, -, L, HOME）を押下・離します。
起動時にLボタンを6回押す処理が含まれています（意図された動作によります）。
SWモードは、15番ピンの状態によって起動時に自動的に判定されます。
設定モード:

OLEDディスプレイに設定項目名と現在の値を表示します。
デジタル入力ピン6（数値減少）、7（数値増加）、8（決定）に接続されたボタンを使用して、以下の設定項目を調整できます。
SE0, SE1, SE2, SE3: 各アナログ入力の感度閾値
PA, PB, PC, PD, PE: 各種遅延時間パラメータ
調整した設定値はEEPROMに保存され、次回起動時に読み込まれます。
設定モードはPCモードでのみ、14番ピンのボタンで切り替え可能です。
OLEDディスプレイ表示:

起動時に「HIDtaiko ver.1.2.4」と表示します。
通常モードでは、「PC MODE」または「SW MODE」と表示します。
設定モードでは、「SET MODE」と現在の設定項目名と値を表示します。
EEPROMへの設定保存:

設定モードで変更された値は、決定ボタン押下時または設定モード終了時にEEPROMに保存されます。
起動時にEEPROMから設定値が読み込まれます。
使用ライブラリ
SPI.h: SPI通信を使用するためのライブラリ（直接的な使用は見られません）。
Wire.h: I2C通信を使用するためのライブラリ（OLEDディスプレイとの通信に使用）。
Adafruit_GFX.h: Adafruitのグラフィックライブラリの基本ライブラリ（OLEDディスプレイの描画に使用）。
Adafruit_SSD1306.h: AdafruitのSSD1306 OLEDディスプレイを制御するためのライブラリ。
EEPROM.h: ArduinoのEEPROM（不揮発性メモリ）への読み書きを行うためのライブラリ。
NintendoSwitchControlLibrary.h: Nintendo Switchへの入力レポートを送信するためのライブラリ。
Keyboard.h: PCにキーボード入力をエミュレートするためのライブラリ。
定数と変数
SCREEN_WIDTH, SCREEN_HEIGHT: OLEDディスプレイの解像度。
OLED_RESET: OLEDリセットピンの設定（-1はリセットピンを使用しない設定）。
display: Adafruit_SSD1306クラスのインスタンス（OLED制御用）。
numSettings: 設定項目の数。
settings[]: 現在の設定値を格納する配列。
currentSetting: 現在選択されている設定項目のインデックス。
settingMode: 設定モードの状態（trueで設定モード）。
swswitching: SWモードの状態（trueでSWモード）。
lastDebounceTime, debounceDelay: ボタンのチャタリング防止用変数。
settingNames[]: 設定項目の名前の配列（OLED表示用）。
modeNames[]: 動作モードの名前の配列（OLED表示用）。
de: デジタル入力の遅延時間（PCモード時）。
A0pin, A1pin, A2pin, A3pin: アナログ入力ピンの定義。
left, middleleft, middletight, right: PCモード時のキーボードキー定義。
aa, cc, swA, swB: SWモード時の遅延時間パラメータ定義。
sv0, sv1, sv2, sv3: 各アナログ入力の以前の値（変化量検出用）。
ti0, ti1, ti2, ti3: 各アナログ入力のタイマー（連続入力防止用）。
time, timec, ti: 汎用タイマー変数。
setup()関数
各デジタル入力ピン（4-10, 14, 15）を入力プルアップモードに設定します。
15番ピンの状態を読み取り、HIGHであればswswitchingをtrueに設定し、Switch制御ライブラリを初期化します。
シリアル通信を115200bpsで開始し、起動メッセージを送信します。
swswitchingの状態に応じて、現在のモード（PCまたはSW）をシリアルモニタに表示します。
OLEDディスプレイを初期化し、「HIDtaiko ver.1.2.4」という起動画面を2秒間表示します。
loadSettings()関数を呼び出し、EEPROMから設定値を読み込みます。
displayMode()関数を呼び出し、現在の動作モードをOLEDに表示します。
SWモードの場合、SwitchのLボタンを6回押す処理を実行します。
loop()関数
checkButtons()関数を呼び出し、設定モードへの切り替えボタンの状態を確認します。
settingModeがtrueの場合（設定モード中）：
デジタル入力ピン6（数値減少）、7（数値増加）の状態を読み取り、対応する設定値を増減させ、OLEDに表示します。
デジタル入力ピン8（決定）の状態を読み取り、currentSettingをインクリメントし、全ての設定項目を巡回したら設定モードを終了し、saveSettings()とdisplayMode()を呼び出します。
settingModeがfalseの場合（通常モード）：
アナログ入力ピン（A0-A3）の値を読み取ります。
swswitchingの状態に応じて、PCモードまたはSWモードの処理を実行します。
PCモード: アナログ入力の変化量と時間間隔が設定された閾値を超えた場合、対応するキーボードキーを押下・離します。デジタル入力ピンの状態に応じて、特定のキーボードキーを送信します。
SWモード: アナログ入力の変化量と時間間隔が設定された閾値を超えた場合、対応するSwitchコントローラーのボタンを押下・離します。デジタル入力ピンの状態に応じて、特定のSwitchコントローラーのボタンを押下・離します。
各アナログ入力の現在の値を以前の値として保存します。
関数
loadSettings(): EEPROMから全ての設定値を読み込み、settings[]配列に格納します。
saveSettings(): settings[]配列の値をEEPROMに書き込みます。変更された設定値はシリアルモニタに表示します。
displaySettings(): 設定モード中にOLEDディスプレイに現在の設定項目名と値を表示します。
displayValue(): 設定モード中に変更された数値をOLEDディスプレイの該当箇所のみ更新表示します。
checkButtons(): 設定モード切り替えボタン（14番ピン）の状態を監視し、押された場合に設定モードのオン・オフを切り替えます（PCモードのみ）。
displayMode(): 現在の動作モード（PC MODE, SW MODE, SET MODE）をOLEDディスプレイに表示します。
注意点
このスケッチを使用するには、対応するArduinoボード、OLEDディスプレイ（SSD1306）、およびNintendo Switch制御に必要なハードウェア構成が必要です。
Nintendo Switchとの通信には、追加のライブラリのインストールが必要となる場合があります。
アナログ入力の閾値や遅延時間などの設定値は、使用する環境や好みに合わせて調整してください。
SWモード起動時のLボタン6回押下は、特定の目的がある場合に実装されている可能性があります。必要に応じて動作を確認してください。
ピンの接続や配線ミスは、ハードウェアの故障や誤動作の原因となりますので、十分にご注意ください。
